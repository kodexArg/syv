---
import { Icon } from "@astrojs/starlight/components";
---

<starlight-theme-toggle>
    <button class="theme-toggle" title="Cambiar tema">
        <span class="sr-only">Cambiar tema</span>
        <span class="icon auto"><Icon name="laptop" /></span>
        <span class="icon dark"><Icon name="moon" /></span>
        <span class="icon light"><Icon name="sun" /></span>
    </button>
</starlight-theme-toggle>

<script>
    class StarlightThemeToggle extends HTMLElement {
        constructor() {
            super();
            const button = this.querySelector("button");
            if (button) {
                button.addEventListener("click", () => this.cycleTheme());
                // Update icon on load and when theme changes
                this.updateIcon();
                const observer = new MutationObserver(() => this.updateIcon());
                observer.observe(document.documentElement, {
                    attributes: true,
                    attributeFilter: ["data-theme"],
                });
            }
        }

        cycleTheme() {
            const current = this.getCurrentTheme();
            const next =
                current === "dark"
                    ? "light"
                    : current === "light"
                      ? "auto"
                      : "dark";
            this.setTheme(next);
        }

        getCurrentTheme() {
            return localStorage.getItem("starlight-theme") || "auto";
        }

        setTheme(theme) {
            localStorage.setItem("starlight-theme", theme);
            if (theme === "auto") {
                const systemTheme = window.matchMedia(
                    "(prefers-color-scheme: dark)",
                ).matches
                    ? "dark"
                    : "light";
                document.documentElement.setAttribute(
                    "data-theme",
                    systemTheme,
                );
            } else {
                document.documentElement.setAttribute("data-theme", theme);
            }
            this.updateIcon();
        }

        updateIcon() {
            const theme = this.getCurrentTheme();
            this.querySelectorAll(".icon").forEach((el) => {
                el.classList.toggle("visible", el.classList.contains(theme));
            });
        }
    }
    customElements.define("starlight-theme-toggle", StarlightThemeToggle);
</script>

<style>
    .theme-toggle {
        background: none;
        border: none;
        cursor: pointer;
        padding: 0;
        display: flex;
        align-items: center;
        color: var(--sl-color-text-accent);
        transition: color 0.2s;
    }

    .theme-toggle:hover {
        color: var(--sl-color-text);
    }

    .icon {
        display: none;
    }

    .icon.visible {
        display: block;
    }

    /* Ensure icons are sized correctly */
    .icon :global(svg) {
        width: 1.25rem;
        height: 1.25rem;
    }
</style>
