---
import { getCollection } from 'astro:content';
import { DocumentSchema, getDocumentConfig } from '../../content/config';
import Icon from '../../components/ui/Icon.astro';

interface NavigationItem {
  displayName: string;
  url: string;
  description?: string;
}

interface OrganizedFolder {
  url: string;
  items: NavigationItem[];
}

const organizeByFolders = (entries: any[]): Record<string, OrganizedFolder> => {
  const organized: Record<string, OrganizedFolder> = {};
  
  for (const entry of entries) {
    const pathParts = entry.id.split('/');
    const folder = pathParts.length > 1 ? pathParts[0] : '_root';
    
    if (!organized[folder]) {
      organized[folder] = { url: '', items: [] };
    }
    
    organized[folder].items.push({
      displayName: entry.data.titulo || entry.id.split('/').pop(),
      url: `/docs/${entry.collection}/${entry.id}/`,
      description: entry.data.descripcion
    });
  }
  
  for (const folder in organized) {
    organized[folder].items.sort((a, b) => 
      a.displayName.localeCompare(b.displayName, 'es', { numeric: true })
    );
    if (organized[folder].items.length > 0) {
      organized[folder].url = organized[folder].items[0].url;
    }
  }
  
  return organized;
};

const estructuraNavegacion = (await Promise.all(
  Object.entries(DocumentSchema.getAllCollections()).map(async ([key, config]) => {
    try {
      const entries = await getCollection(key as any);
      
      if (entries.length === 0) return null;
      
      const collectionConfig = getDocumentConfig(key);

      return {
        key,
        fullName: collectionConfig.getName(),
        icon: collectionConfig.getIcon(),
        organizedFolders: organizeByFolders(entries)
      };
    } catch {
      return null;
    }
  })
)).filter((section): section is NonNullable<typeof section> => section !== null);
---

<aside 
  id="sidebar" 
  class="font-sans bg-stone-50 border-r border-military-200 fixed left-0 top-12 w-80 h-[calc(100vh-3rem)] -translate-x-80 transition-transform duration-300 z-40 overflow-y-auto md:w-64 md:translate-x-0 [&.sidebar-open]:translate-x-0"
>
  <div class="p-4">
    <header class="mb-4">
      <h2 class="text-lg font-semibold mb-2 text-military-800">Documentación</h2>
      <p class="text-sm text-military-600">Subordinación y Valor</p>
    </header>
    
    <nav>
      {estructuraNavegacion.map((section) => (
        <section class="mb-4">
          <h3 class="text-sm font-medium mb-2 text-military-800 flex items-center gap-2">
            <Icon name={section.icon} />
            {section.fullName}
          </h3>
          
          <div class="ml-4">
            {Object.entries(section.organizedFolders).map(([folderName, folderData]) => (
              <div>
                {folderName !== '_root' && (
                  <a 
                    href={folderData.url} 
                    class="text-sm text-military-600 flex items-center gap-2 py-1 no-underline hover:text-military-800 transition-colors"
                  >
                    <Icon name="folder-solid" size="sm" />
                    {folderName}
                  </a>
                )}
                
                <div class={folderName !== '_root' ? 'ml-4' : ''}>
                  {folderData.items.map((element) => (
                    <a 
                      href={element.url} 
                      title={element.description} 
                      class="text-sm text-military-600 flex items-center gap-2 py-1 no-underline hover:text-military-800 transition-colors"
                    >
                      <Icon name="document-solid" size="sm" />
                      <span>{element.displayName}</span>
                    </a>
                  ))}
                </div>
              </div>
            ))}
          </div>
        </section>
      ))}
    </nav>
  </div>
</aside>

 