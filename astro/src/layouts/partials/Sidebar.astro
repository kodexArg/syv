---
import { getCollection } from 'astro:content';
import { CONFIGURACIONES_COLECCIONES } from '../../content/config';
import Icon from '../../components/ui/Icon.astro';

interface ElementoNavegacion {
  displayName: string;
  url: string;
  description?: string;
}

interface CarpetaOrganizada {
  url: string;
  items: ElementoNavegacion[];
}

const organizarPorCarpetas = (entradas: any[]): Record<string, CarpetaOrganizada> => {
  const organizado: Record<string, CarpetaOrganizada> = {};
  
  for (const entrada of entradas) {
    const partesDeLaRuta = entrada.id.split('/');
    const carpeta = partesDeLaRuta.length > 1 ? partesDeLaRuta[0] : '_root';
    
    if (!organizado[carpeta]) {
      organizado[carpeta] = { url: '', items: [] };
    }
    
    organizado[carpeta].items.push({
      displayName: entrada.data.titulo || entrada.id.split('/').pop(),
      url: `/docs/${entrada.collection}/${entrada.id}/`,
      description: entrada.data.descripcion
    });
  }
  
  for (const carpeta in organizado) {
    organizado[carpeta].items.sort((a, b) => 
      a.displayName.localeCompare(b.displayName, 'es', { numeric: true })
    );
    if (organizado[carpeta].items.length > 0) {
      organizado[carpeta].url = organizado[carpeta].items[0].url;
    }
  }
  
  return organizado;
};

const estructuraNavegacion = (await Promise.all(
  Object.entries(CONFIGURACIONES_COLECCIONES).map(async ([clave, config]) => {
    try {
      const entradas = await getCollection(clave as any);
      
      if (entradas.length === 0) return null;
      
      return {
        clave,
        nombreCompleto: config.nombreCompleto,
        icono: config.icono,
        carpetasOrganizadas: organizarPorCarpetas(entradas)
      };
    } catch {
      return null;
    }
  })
)).filter((seccion): seccion is NonNullable<typeof seccion> => seccion !== null);
---

<aside 
  id="sidebar" 
  class="font-sans bg-stone-50 border-r border-military-200 fixed left-0 top-12 w-80 h-[calc(100vh-3rem)] -translate-x-80 transition-transform duration-300 z-40 overflow-y-auto md:w-64 md:translate-x-0 [&.sidebar-open]:translate-x-0"
>
  <div class="p-4">
    <header class="mb-4">
      <h2 class="text-lg font-semibold mb-2 text-military-800">Documentación</h2>
      <p class="text-sm text-military-600">Subordinación y Valor</p>
    </header>
    
    <nav>
      {estructuraNavegacion.map((seccion) => (
        <section class="mb-4">
          <h3 class="text-sm font-medium mb-2 text-military-800 flex items-center gap-2">
            <Icon name={seccion.icono} />
            {seccion.nombreCompleto}
          </h3>
          
          <div class="ml-4">
            {Object.entries(seccion.carpetasOrganizadas).map(([nombreCarpeta, datosCarpeta]) => (
              <div>
                {nombreCarpeta !== '_root' && (
                  <a 
                    href={datosCarpeta.url} 
                    class="text-sm text-military-600 flex items-center gap-2 py-1 no-underline hover:text-military-800 transition-colors"
                  >
                    <Icon name="folder-solid" size="sm" />
                    {nombreCarpeta}
                  </a>
                )}
                
                <div class={nombreCarpeta !== '_root' ? 'ml-4' : ''}>
                  {datosCarpeta.items.map((elemento) => (
                    <a 
                      href={elemento.url} 
                      title={elemento.description} 
                      class="text-sm text-military-600 flex items-center gap-2 py-1 no-underline hover:text-military-800 transition-colors"
                    >
                      <Icon name="document-solid" size="sm" />
                      <span>{elemento.displayName}</span>
                    </a>
                  ))}
                </div>
              </div>
            ))}
          </div>
        </section>
      ))}
    </nav>
  </div>
</aside>

 