---
import { getCollection, render } from 'astro:content';
import { DOCUMENTS_SCHEMA, DOCUMENTS_SCHEMA_KEYS } from '../../../content/constants';
import BaseLayout from '../../../layouts/BaseLayout.astro';
import MarkdownLayout from '../../../layouts/MarkdownLayout.astro';

interface Props {
  entry: any;
}

export const getStaticPaths = async () => {
  const paths: { params: { collection: string; slug: string }; props: { entry: any } }[] = [];
  
  for (const collectionKey of DOCUMENTS_SCHEMA_KEYS) {
    try {
      const entries = await getCollection(collectionKey as any);
      const collectionPaths = entries.map((entry: any) => ({
        params: { collection: collectionKey, slug: entry.id },
        props: { entry },
      }));
      paths.push(...collectionPaths);
    } catch {
      // Skip collections that don't exist
    }
  }
  
  return paths;
};

const { entry } = Astro.props as Props;
const collectionKey = Astro.params.collection || '';
const collectionData = DOCUMENTS_SCHEMA[collectionKey as keyof typeof DOCUMENTS_SCHEMA];

const { Content, headings } = await render(entry);
const collectionName = collectionData?.name || '';
const entryTitle = entry.data?.titulo || entry.id.split('/').pop() || 'Untitled';
---

<BaseLayout 
  title={entryTitle}
  description={entry.data?.descripcion}
  currentPath={Astro.url.pathname}
>
  <MarkdownLayout 
    title={entryTitle}
    description={entry.data?.descripcion}
    collection={collectionName}
    headings={headings}
    tags={entry.data.tags}
    date={entry.data.fecha ? new Date(entry.data.fecha) : undefined}
    folder={entry.data.carpeta}
  >
    <Content />
  </MarkdownLayout>
</BaseLayout>