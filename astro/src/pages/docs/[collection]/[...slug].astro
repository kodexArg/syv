---
import { getCollection, type CollectionEntry, render } from 'astro:content';
import { COLLECTION_KEYS, getCollectionConfig, type CollectionKey } from '../../../content/config';
import BaseLayout from '../../../layouts/BaseLayout.astro';
import MarkdownLayout from '../../../layouts/MarkdownLayout.astro';

interface Props {
  entry: CollectionEntry<CollectionKey>;
}

export const getStaticPaths = async () => {
  const paths = await Promise.all(
    COLLECTION_KEYS.map(async (collectionKey) => {
      try {
        const entries = await getCollection(collectionKey);
        return entries.map((entry) => ({
          params: { collection: collectionKey, slug: entry.id },
          props: { entry },
        }));
      } catch {
        return [];
      }
    })
  );
  
  return paths.flat();
};

const { entry } = Astro.props;

const { Content, headings } = await render(entry);
const collectionName = getCollectionConfig(Astro.params.collection || '').getName();
---

<BaseLayout 
  title={entry.data.title}
  description={entry.data.description}
  currentPath={Astro.url.pathname}
>
  <MarkdownLayout 
    title={entry.data.title}
    description={entry.data.description}
    collection={collectionName}
    headings={headings}
    tags={entry.data.tags}
    date={entry.data.date ? new Date(entry.data.date) : undefined}
    folder={entry.data.folder}
  >
    <Content />
  </MarkdownLayout>
</BaseLayout>